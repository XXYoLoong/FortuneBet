import { BET_GRID, ROUND_DURATION_MS } from '../../common/constants';
import type { BetOption, BetTicket, UserProfile, GameRound } from '../../common/types';
import { useHistoryService } from '../../services/ServiceLocator';
import { ensureStorage, StorageService } from '../../services/StorageService';

@Entry
@Component
export struct GamePage {
  @Prop account: string = '';
  @State bets: Map<number, number> = new Map();
  @State countdownMs: number = 0;
  @State isRoundActive: boolean = false;
  @State resultValue: number | undefined = undefined;
  @State winnings: number = 0;
  @State showRules: boolean = false;
  @State showSettleDialog: boolean = false;
  @State balance: number = 0;
  @State profile: UserProfile | undefined = undefined;

  private timer: number = 0;
  private storage?: StorageService;
  private roundStartTime: number = 0;

  async aboutToAppear(): Promise<void> {
    this.storage = await ensureStorage(getContext(this));
    await this.loadData();
    this.startTimer();
  }

  onPageShow(): void {
    this.loadData();
  }

  aboutToDisappear(): void {
    if (this.timer) {
      clearInterval(this.timer);
    }
  }

  private async loadData(): Promise<void> {
    if (!this.storage) return;
    const targetAccount = this.account || await this.storage.getLoginAccount();
    if (!targetAccount) return;

    // Ëé∑ÂèñÊï∞ÊçÆÂπ∂Â§ÑÁêÜÊØèÊó•‰Ωé‰øù
    const user = await this.storage.ensureDailyCoins(targetAccount);
    if (user) {
      this.profile = user;
      this.balance = user.balance ?? 0;
    }
  }

  private startTimer(): void {
    this.timer = setInterval(() => {
      if (this.isRoundActive) {
        const elapsed = Date.now() - this.roundStartTime;
        const remaining = ROUND_DURATION_MS - elapsed;
        this.countdownMs = Math.max(0, remaining);

        if (this.countdownMs === 0 && !this.showSettleDialog) {
          this.handleSettle();
        }
      }
    }, 100);
  }

  private async handleStartRound(): Promise<void> {
    // ÂºÄÂßãÂâçÂÜçÊ¨°Âà∑Êñ∞Êï∞ÊçÆÔºåÈò≤Ê≠¢‰ΩôÈ¢ù‰∏çÂêåÊ≠•
    await this.loadData();
    if (this.balance <= 0) return;

    this.isRoundActive = true;
    this.roundStartTime = Date.now();
    this.countdownMs = ROUND_DURATION_MS;
    this.resultValue = undefined;
    this.winnings = 0;
    this.showSettleDialog = false;
    this.bets = new Map();
  }

  private updateBet(value: number, amount: number): void {
    if (!this.isRoundActive) return;
    if (amount < 0) return;

    const currentBet = this.bets.get(value) || 0;
    const totalBet = this.getTotalBet();
    const newTotal = totalBet - currentBet + amount;

    // ÁÆÄÂçïÁöÑÂÆ¢Êà∑Á´ØÊ†°È™åÔºåÂÆûÈôÖÊâ£Ê¨æÂú®ÁªìÁÆó
    if (newTotal > this.balance) return;

    if (amount === 0) {
      this.bets.delete(value);
    } else {
      this.bets.set(value, amount);
    }
  }

  private getBetAmount(value: number): number {
    return this.bets.get(value) || 0;
  }

  private getTotalBet(): number {
    let total = 0;
    this.bets.forEach((amount) => total += amount);
    return total;
  }

  private getRemainingCoins(): number {
    return this.balance - this.getTotalBet();
  }

  // Ê†∏ÂøÉÁªìÁÆóÈÄªËæë
  private async handleSettle(): Promise<void> {
    if (!this.isRoundActive) return;

    this.isRoundActive = false;
    const totalBet = this.getTotalBet();
    const resultValue = this.pickRandomValue();
    this.resultValue = resultValue;

    const betAmount = this.bets.get(resultValue) || 0;
    // ËÆ°ÁÆóÂ•ñÈáë (Â¶ÇÊûúÂéã‰∏≠)
    this.winnings = betAmount > 0 ? betAmount * resultValue : 0;

    // Êï∞ÊçÆÂ∫ìÊìç‰ΩúÔºöÊâ£Ê¨æ‰∏éÂèëÂ•ñ
    if (this.storage) {
      // 1. Êâ£Èô§Êú¨Èáë
      await this.storage.updateBalance(this.account, -totalBet);
      // 2. ÂèëÊîæÂ•ñÈáë
      if (this.winnings > 0) {
        await this.storage.updateBalance(this.account, this.winnings);
      }
      // 3. Á´ãÂç≥Âà∑Êñ∞Êú¨Âú∞ÂÜÖÂ≠ò‰∏≠ÁöÑ‰ΩôÈ¢ùÔºå‰ª•‰æøÂ≠òÂÖ•ÂéÜÂè≤ËÆ∞ÂΩï
      await this.loadData();
    }

    // ËÆ∞ÂΩïÂéÜÂè≤
    const historySvc = useHistoryService();
    try {
      const roundNumber = await historySvc.getNextRoundNumber(this.account);
      const betsArray: BetTicket[] = [];
      this.bets.forEach((amount, value) => betsArray.push({ value, amount }));

      const round: GameRound = {
        id: `${Date.now()}-${Math.random()}`,
        roundNumber,
        account: this.account,
        coinsUsed: totalBet,
        coinsEarned: this.winnings,
        resultValue,
        bets: betsArray,
        createdAt: Date.now(),
        // „ÄêÈáçË¶Å„ÄëËÆ∞ÂΩïÂΩìÂâçËøô‰∏ÄÂàªÁöÑ‰ΩôÈ¢ùÂø´ÁÖß
        balanceSnapshot: this.balance
      };
      await historySvc.saveRound(round);
    } catch (e) {
      console.error('‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:', e);
    }

    this.showSettleDialog = true;
  }

  // Âä†ÊùÉÈöèÊú∫ÁÆóÊ≥ï
  private pickRandomValue(): number {
    const totalWeight = BET_GRID.reduce((sum, item) => sum + item.weight, 0);
    let random = Math.random() * totalWeight;
    for (const item of BET_GRID) {
      random -= item.weight;
      if (random <= 0) return item.value;
    }
    return BET_GRID[BET_GRID.length - 1].value;
  }

  private async closeSettleDialog(): Promise<void> {
    this.showSettleDialog = false;
    this.resultValue = undefined;
    this.winnings = 0;
    this.bets = new Map();
    // ÂÖ≥Èó≠ÂºπÁ™óÂêéÂÜçÊ¨°Á°ÆËÆ§‰ΩôÈ¢ù
    await this.loadData();
  }

  private formatCountdown(): string {
    const sec = Math.floor(this.countdownMs / 1000);
    const m = Math.floor(sec / 60).toString().padStart(2, '0');
    const s = (sec % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
  }

  build() {
    Stack() {
      // Â∫ïÂ±ÇÊ∏∏ÊàèÁïåÈù¢
      Column() {
        this.renderHeader();
        this.renderGameArea();
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#0a0e27');

      // ÈÅÆÁΩ©Â±Ç (Áî®‰∫éËßÑÂàôÊàñÁªìÁÆó)
      if (this.showSettleDialog || this.showRules) {
        Rect()
          .width('100%')
          .height('100%')
          .fill('#99000000') // ÂçäÈÄèÊòéÈªëËÉåÊôØ
          .onClick(() => {
            // ÁÇπÂáªÁ©∫ÁôΩÂ§ÑÂÖ≥Èó≠ËßÑÂàôÔºå‰ΩÜ‰∏çËÉΩÂÖ≥Èó≠ÁªìÁÆóÁªìÊûú
            if (this.showRules) this.showRules = false;
          })
      }

      // ÂºπÁ™óÂ±Ç
      if (this.showSettleDialog) {
        this.renderSettleDialog();
      }

      if (this.showRules) {
        this.renderRulesDialog();
      }
    }
    .width('100%')
    .height('100%');
  }

  @Builder
  private renderHeader() {
    Row() {
      Column() {
        Text('È∏øËøêÊäºÂÆù')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor('#ffffff');
        Text(`‰ΩôÈ¢ù: ${this.balance} Â∏Å`)
          .fontSize(13)
          .fontColor('#a0a0a0')
          .margin({ top: 4 });
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1);

      Button('ËßÑÂàô')
        .type(ButtonType.Normal)
        .fontSize(13)
        .fontColor('#ffffff')
        .backgroundColor('#1a1f3a')
        .borderRadius(16)
        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
        .onClick(() => this.showRules = true);
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 12, bottom: 12 }) // È°∂ÈÉ®ÁïôÁôΩÈÄÇÈÖç
    .backgroundColor('#15182e');
  }

  @Builder
  private renderGameArea() {
    Column() {
      if (!this.isRoundActive) {
        // --- ÂæÖÊú∫Áä∂ÊÄÅ ---
        Column() {
          Text('ÂáÜÂ§áÂºÄÂßãÊñ∞‰∏ÄËΩÆ')
            .fontSize(20)
            .fontWeight(FontWeight.Medium)
            .fontColor('#ffffff')
            .margin({ bottom: 40 });

          Button('ÂºÄÂßãÊ∏∏Êàè', { type: ButtonType.Capsule })
            .width(240)
            .height(56)
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .backgroundColor('#e04542')
            .fontColor('#ffffff')
            .enabled(this.balance > 0)
            .onClick(async () => await this.handleStartRound());

          if (this.balance <= 0) {
            Text('‰ΩôÈ¢ù‰∏çË∂≥ÔºåÁ≥ªÁªüÊ≠£Âú®‰∏∫ÊÇ®Ë°•Áªô...')
              .fontSize(12)
              .fontColor('#ff6b6b')
              .margin({ top: 20 });
          }
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .layoutWeight(1);
      } else {
        // --- Ê∏∏ÊàèËøõË°å‰∏≠ ---
        Column() {
          // ÂÄíËÆ°Êó∂Âå∫Âüü
          Column() {
            Text('Ë∑ùÁ¶ªÂºÄÂ•ñ‰ªÖÂâ©')
              .fontSize(14)
              .fontColor('#a0a0a0')
              .margin({ bottom: 8 });
            Text(this.formatCountdown())
              .fontSize(60)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.countdownMs < 10000 ? '#ff6b6b' : '#4ecdc4');
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#1a1f3a')
          .margin({ bottom: 20 });

          // ‰∏ãÊ≥®Âå∫ - ‰ΩøÁî® List ÂåÖË£π Grid Èò≤Ê≠¢Â∞èÂ±èÊ∫¢Âá∫
          List() {
            ListItem() {
              Grid() {
                ForEach(BET_GRID, (item: BetOption) => {
                  GridItem() {
                    this.renderBetCard(item);
                  }
                }, (item: BetOption) => item.value.toString())
              }
              .columnsTemplate('1fr 1fr 1fr 1fr')
              .columnsGap(10)
              .rowsGap(10)
              .width('100%')
              .padding({ left: 16, right: 16 });
            }
          }
          .layoutWeight(1);

          // Â∫ïÈÉ®ÁªüËÆ°Ê†è
          Row() {
            Text(`ÊÄª‰∏ãÊ≥®: ${this.getTotalBet()}`)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#ffffff');
            Blank();
            Text(`Ââ©‰Ωô: ${this.getRemainingCoins()}`)
              .fontSize(16)
              .fontColor('#a0a0a0');
          }
          .width('100%')
          .padding({ left: 20, right: 20, top: 16, bottom: 24 })
          .backgroundColor('#15182e');
        }
        .width('100%')
        .layoutWeight(1);
      }
    }
    .width('100%')
    .layoutWeight(1);
  }

  @Builder
  private renderBetCard(item: BetOption) {
    Column() {
      // È´òÂÄçÁéáÁî®ÈáëËâ≤ÊòæÁ§∫
      Text(`${item.value}x`)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(item.value >= 50 ? '#ffd700' : '#ffffff')
        .margin({ bottom: 4 });

      Text(`ËÉúÁéá ${(item.weight / 10).toFixed(1)}%`)
        .fontSize(10)
        .fontColor('#888888')
        .margin({ bottom: 8 });

      // ËæìÂÖ•Ê°Ü
      TextInput({
        placeholder: '0',
        text: this.getBetAmount(item.value) > 0 ? this.getBetAmount(item.value).toString() : ''
      })
        .type(InputType.Number)
        .width('100%')
        .height(32)
        .backgroundColor(this.getBetAmount(item.value) > 0 ? '#ffffff' : '#252a42')
        .borderRadius(6)
        .padding({ left: 0, right: 0 })
        .textAlign(TextAlign.Center)
        .fontSize(14)
        .fontColor('#333333')
        .enabled(this.isRoundActive && this.getRemainingCoins() > 0)
        .onChange((v: string) => {
          const numStr = v.replace(/[^0-9]/g, '');
          const amount = Number.parseInt(numStr) || 0;
          this.updateBet(item.value, amount);
        });
    }
    .width('100%')
    .padding(10)
    .backgroundColor(this.getBetAmount(item.value) > 0 ? '#e04542' : '#1a1f3a')
    .borderRadius(10)
    .border({ width: 1, color: this.getBetAmount(item.value) > 0 ? '#e04542' : '#252a42' });
  }

  @Builder
  private renderSettleDialog() {
    Column() {
      Text(this.winnings > 0 ? 'üéâ Â§ßËé∑ÂÖ®ËÉúÔºÅ' : 'üíî ËøêÊ∞îÊ¨†‰Ω≥')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#ffffff')
        .margin({ bottom: 24 });

      Text(`ÂºÄÂ•ñÂè∑Á†Å: ${this.resultValue}x`)
        .fontSize(40)
        .fontWeight(FontWeight.Bold)
        .fontColor('#ffd700')
        .margin({ bottom: 32 });

      if (this.winnings > 0) {
        Column() {
          Text(`+ ${this.winnings}`)
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor('#4ecdc4')
            .margin({ bottom: 8 });
          Text('Ëµ¢ÂæóÊ∏∏ÊàèÂ∏Å')
            .fontSize(14)
            .fontColor('#a0a0a0')
            .margin({ bottom: 32 });
        }
      } else {
        Column() {
          Text(`- ${this.getTotalBet()}`)
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor('#ff6b6b')
            .margin({ bottom: 8 });
          Text('ÊçüÂ§±Êú¨Èáë')
            .fontSize(14)
            .fontColor('#a0a0a0')
            .margin({ bottom: 32 });
        }
      }

      Button('Êî∂ÂÖ•Âõä‰∏≠ (ËøîÂõû)')
        .width(200)
        .height(48)
        .backgroundColor('#e04542')
        .fontColor('#ffffff')
        .onClick(async () => await this.closeSettleDialog());
    }
    .width('80%')
    .padding(32)
    .backgroundColor('#1a1f3a')
    .borderRadius(24)
    .shadow({ radius: 20, color: '#aa000000' });
  }

  @Builder
  private renderRulesDialog() {
    Column() {
      Text('Ê∏∏ÊàèËßÑÂàô')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#ffffff')
        .margin({ bottom: 16, top: 8 });

      // ÈôêÂà∂È´òÂ∫¶Âπ∂ÂÖÅËÆ∏ÊªëÂä®
      Scroll() {
        Column({ space: 12 }) {
          Text('1. ÊûÅÈÄüÂºÄÂ•ñÔºö\nÁÇπÂáªÂºÄÂßãÂêéÔºåÊÇ®Êúâ1ÂàÜÈíüÊó∂Èó¥ËøõË°åÂàÜÊûêÂíå‰∏ãÊ≥®„ÄÇ')
            .fontSize(14).fontColor('#cccccc').lineHeight(20);

          Text('2. ËµîÁéáËØ¥ÊòéÔºö\nË°®Ê†º‰∏≠ÁöÑÊï∞Â≠óÔºàÂ¶Ç50xÔºâ‰ª£Ë°®ÂÄçÁéá„ÄÇÂ¶ÇÊûúÊÇ®Âú®"50x"‰∏ãÊ≥®100Â∏ÅÔºå‰∏îÊúÄÁªàÂºÄÂ•ñ‰∏∫50xÔºåÊÇ®Â∞ÜËé∑Âæó 100 * 50 = 5000 Â∏ÅÔºÅ')
            .fontSize(14).fontColor('#cccccc').lineHeight(20);

          Text('3. È£éÈô©ÊèêÁ§∫Ôºö\nÂÄçÁéáË∂äÈ´òÔºàÂ¶Ç100xÔºâÔºåÂá∫Áé∞ÁöÑÊ¶ÇÁéáË∂ä‰ΩéÔºõÂÄçÁéáË∂ä‰ΩéÔºàÂ¶Ç2xÔºâÔºåÂá∫Áé∞ÁöÑÊ¶ÇÁéáË∂äÈ´ò„ÄÇËØ∑ÂêàÁêÜÂàÜÈÖçÊÇ®ÁöÑÁ≠πÁ†Å„ÄÇ')
            .fontSize(14).fontColor('#cccccc').lineHeight(20);

          Text('4. ÁªìÁÆóÊú∫Âà∂Ôºö\nÂÄíËÆ°Êó∂ÁªìÊùüÂêéÁ≥ªÁªüËá™Âä®ÂºÄÂ•ñ„ÄÇËã•‰∏≠Â•ñÔºåÂ•ñÂä±Ëá™Âä®Â≠òÂÖ•‰ΩôÈ¢ùÔºõËã•Êú™‰∏≠Â•ñÔºåÊâ£Èô§‰∏ãÊ≥®Êú¨Èáë„ÄÇ')
            .fontSize(14).fontColor('#cccccc').lineHeight(20);

          Text('5. ÊØèÊó•Á¶èÂà©Ôºö\nÊØèÊó•È¶ñÊ¨°ÁôªÂΩïÊàñ‰ΩôÈ¢ù‰∏çË∂≥Êó∂ÔºåÁ≥ªÁªü‰ºöËá™Âä®ÂèëÊîæ30Â∏Å‰Ωé‰øù„ÄÇ')
            .fontSize(14).fontColor('#cccccc').lineHeight(20);

          Text('Ê¶ÇÁéáÂÖ¨Á§∫Ôºö\n100x(0.1%), 50x(0.3%), 30x(0.6%), 20x(1.5%)\n15x(2.5%), 12x(5.0%), 10x(8.0%), 8x(12.0%)\n6x(15.0%), 5x(20.0%), 4x(25.0%), 2x(10.0%)')
            .fontSize(12).fontColor('#666666').margin({ top: 10 });
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)
        .padding({ left: 8, right: 8 })
      }
      .height('300vp') // ÈôêÂà∂È´òÂ∫¶
      .scrollBar(BarState.Auto);

      Button('ÊàëÊòéÁôΩ‰∫Ü')
        .width('100%')
        .height(44)
        .margin({ top: 20 })
        .backgroundColor('#e04542')
        .fontColor('#ffffff')
        .onClick(() => this.showRules = false);
    }
    .width('85%')
    .padding(24)
    .backgroundColor('#1a1f3a')
    .borderRadius(20)
    .shadow({ radius: 20, color: '#aa000000' });
  }
}